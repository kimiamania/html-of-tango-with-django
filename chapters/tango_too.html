<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from www.tangowithdjango.com/book/chapters/tango_too.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 21 Nov 2013 06:40:53 GMT -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>14. Doing the Tango with Rango! &mdash; How to Tango with Django</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/twd.ico"/>
    <link rel="top" title="How to Tango with Django" href="../index-2.html" />
    <link rel="next" title="15. AJAX, Django and JQuery" href="ajax.html" />
    <link rel="prev" title="13. Making Rango Tango! Exercises" href="tango.html" />
 <style type="text/css">
	img{
	    width: 85%; /* you can use % */
	    height: auto;
	}
	
	table {
		margin: auto;
	}
	
	p.caption {
		font-size: 10pt;
		font-style: italic;
	}
 </style>
 <script type="text/javascript">

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','../../../www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44397330-1', 'tangowithdjango.com');
  ga('send', 'pageview');
     

  </script>      

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        
        <li class="right" >
          <a href="ajax.html" title="15. AJAX, Django and JQuery"
             accesskey="N">next</a>
          </li>
		
        <li class="right" >
          <a href="tango.html" title="13. Making Rango Tango! Exercises"
             accesskey="P">previous</a>
          </li>
		
        <li><a href="../index-2.html">How to Tango with Django</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index-2.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">14. Doing the Tango with Rango!</a><ul>
<li><a class="reference internal" href="#list-categories-on-each-page">14.1. List Categories on Each Page</a><ul>
<li><a class="reference internal" href="#creating-a-category-list-template">14.1.1. Creating a Category List Template</a></li>
<li><a class="reference internal" href="#updating-the-base-template">14.1.2. Updating the Base Template</a></li>
<li><a class="reference internal" href="#creating-get-category-list-function">14.1.3. Creating Get Category List Function</a></li>
<li><a class="reference internal" href="#updating-views">14.1.4. Updating Views</a></li>
</ul>
</li>
<li><a class="reference internal" href="#searching-within-a-category-page">14.2. Searching Within a Category Page</a><ul>
<li><a class="reference internal" href="#decommissioning-generic-search">14.2.1. Decommissioning Generic Search</a></li>
<li><a class="reference internal" href="#creating-a-search-form-template">14.2.2. Creating a Search Form Template</a></li>
<li><a class="reference internal" href="#updating-the-category-view">14.2.3. Updating the Category View</a></li>
</ul>
</li>
<li><a class="reference internal" href="#view-profile">14.3. View Profile</a><ul>
<li><a class="reference internal" href="#creating-the-profile-template">14.3.1. Creating the Profile Template</a></li>
<li><a class="reference internal" href="#creating-profile-view">14.3.2. Creating Profile View</a></li>
<li><a class="reference internal" href="#mapping-the-profile-view-and-url">14.3.3. Mapping the Profile View and URL</a></li>
<li><a class="reference internal" href="#id1">14.3.4. Updating the Base Template</a></li>
</ul>
</li>
<li><a class="reference internal" href="#track-page-click-throughs">14.4. Track Page Click Throughs</a><ul>
<li><a class="reference internal" href="#creating-a-url-tracking-view">14.4.1. Creating a URL Tracking View</a></li>
<li><a class="reference internal" href="#mapping-url">14.4.2. Mapping URL</a></li>
<li><a class="reference internal" href="#updating-the-category-template">14.4.3. Updating the Category Template</a></li>
<li><a class="reference internal" href="#updating-category-view">14.4.4. Updating Category View</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="tango.html"
                        title="previous chapter">13. Making Rango Tango! Exercises</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ajax.html"
                        title="next chapter">15. AJAX, Django and JQuery</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/chapters/tango_too.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="http://www.tangowithdjango.com/book/search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="doing-the-tango-with-rango">
<span id="tango-too-label"></span><h1>14. Doing the Tango with Rango!<a class="headerlink" href="#doing-the-tango-with-rango" title="Permalink to this headline">¶</a></h1>
<p>Hopefully, you will have been able to complete the exercises given the workflows we provided, if not, or if you need a little help checkout snippets of code and use them within your version of Rango.</p>
<div class="section" id="list-categories-on-each-page">
<h2>14.1. List Categories on Each Page<a class="headerlink" href="#list-categories-on-each-page" title="Permalink to this headline">¶</a></h2>
<div class="section" id="creating-a-category-list-template">
<h3>14.1.1. Creating a Category List Template<a class="headerlink" href="#creating-a-category-list-template" title="Permalink to this headline">¶</a></h3>
<p>Create a <tt class="docutils literal"><span class="pre">category_list.html</span></tt> template so that it looks like the code below:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav nav-list&quot;</span><span class="nt">&gt;</span>
    {% if cat_list %}
        {% for cat in cat_list %}
            <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/rango/category/{{ cat.url }}&quot;</span><span class="nt">&gt;</span>{{ cat.name }}<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
        {% endfor %}
    {% else %}
        <span class="nt">&lt;li&gt;</span>No categories at present.<span class="nt">&lt;/li&gt;</span>
   {% endif %}
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-the-base-template">
<h3>14.1.2. Updating the Base Template<a class="headerlink" href="#updating-the-base-template" title="Permalink to this headline">¶</a></h3>
<p>In the sidebar <tt class="docutils literal"><span class="pre">&lt;div&gt;</span></tt>, add <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">include</span> <span class="pre">&quot;rango/category_list.html&quot;</span> <span class="pre">%}</span></tt> so that the <tt class="docutils literal"><span class="pre">base.html</span></tt> contains:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;well sidebar-nav&quot;</span><span class="nt">&gt;</span>
   {% block sidebar %}
   {% endblock %}
   <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;cats&quot;</span><span class="nt">&gt;</span>
       {% if cat_list %}
           <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav nav-list&quot;</span><span class="nt">&gt;&lt;li&gt;</span>Category List<span class="nt">&lt;/li&gt;&lt;/ul&gt;</span>
           {% include &#39;rango/category_list.html&#39; with cat_list=cat_list %}
       {% endif %}
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-get-category-list-function">
<h3>14.1.3. Creating Get Category List Function<a class="headerlink" href="#creating-get-category-list-function" title="Permalink to this headline">¶</a></h3>
<p>In <tt class="docutils literal"><span class="pre">rango/views.py</span></tt>, create a function called <tt class="docutils literal"><span class="pre">get_category_list()</span></tt> that returns the list of categories.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_category_list</span><span class="p">():</span>
    <span class="n">cat_list</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cat_list</span><span class="p">:</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">encode_url</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cat_list</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-views">
<h3>14.1.4. Updating Views<a class="headerlink" href="#updating-views" title="Permalink to this headline">¶</a></h3>
<p>Then call this function in each of the views that you want to display the category list in the sidebar, and pass the list into the context dictionary. For example, to have the categories showing on the index page, alter the <tt class="docutils literal"><span class="pre">index()</span></tt> view as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">cat_list</span> <span class="o">=</span> <span class="n">get_category_list</span><span class="p">()</span>

    <span class="n">context_dict</span><span class="p">[</span><span class="s">&#39;cat_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_list</span>

    <span class="o">....</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;rango/index.html&#39;</span><span class="p">,</span> <span class="n">context_dict</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>Note: to add the category list to all the other pages, you will need to do some refactoring to pass in all the context variables.</p>
</div>
</div>
<div class="section" id="searching-within-a-category-page">
<h2>14.2. Searching Within a Category Page<a class="headerlink" href="#searching-within-a-category-page" title="Permalink to this headline">¶</a></h2>
<p>Rango aims to provide users with a helpful directory of page links. At the moment, the search functionality is essentially independent of the categories. It would be nicer however to have search integrated into category browsing. Let&#8217;s assume that a user will first browse their category of interest first. If they can&#8217;t find the page that they want, they can then search for it. If they find a page that is suitable, then they can add it to the category that they are in. Let&#8217;s tackle the first part of this description here.</p>
<p>We first need to remove the global search functionality and only let users search within a category. This will mean that we essentially decommission the current search page and search view. After this, we&#8217;ll need to perform the following.</p>
<div class="section" id="decommissioning-generic-search">
<h3>14.2.1. Decommissioning Generic Search<a class="headerlink" href="#decommissioning-generic-search" title="Permalink to this headline">¶</a></h3>
<p>Remove the generic <em>Search</em> link from the menu bar by editing the <tt class="docutils literal"><span class="pre">base.html</span></tt> template. You can also remove or comment out the URL mapping in <tt class="docutils literal"><span class="pre">rango/urls.py</span></tt>.</p>
</div>
<div class="section" id="creating-a-search-form-template">
<h3>14.2.2. Creating a Search Form Template<a class="headerlink" href="#creating-a-search-form-template" title="Permalink to this headline">¶</a></h3>
<p>Take the search form from <tt class="docutils literal"><span class="pre">search.html</span></tt> and put it into the <tt class="docutils literal"><span class="pre">category.html</span></tt>. Be sure to change the action to point to the <tt class="docutils literal"><span class="pre">category()</span></tt> view as shown below.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container-fluid&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>Search for a page.<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;span8 form-search&quot;</span> <span class="na">id=</span><span class="s">&quot;search_form&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;/rango/category/{{ category_name_url }}/&quot;</span><span class="nt">&gt;</span>
        {% csrf_token %}
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;input-long search-query&quot;</span>  <span class="na">name=</span><span class="s">&quot;query&quot;</span> <span class="na">value=</span><span class="s">&quot;{{ category_name }}&quot;</span> <span class="na">id=</span><span class="s">&quot;query&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-success&quot;</span> <span class="na">name=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Search&quot;</span><span class="nt">&gt;</span>Search<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>Also include a <tt class="docutils literal"><span class="pre">&lt;div&gt;</span></tt> to house the results underneath.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container-fluid&quot;</span><span class="nt">&gt;</span>
    {% if result_list %}
        <span class="c">&lt;!-- Display search results in an ordered list --&gt;</span>
        <span class="nt">&lt;ol&gt;</span>
            {% for result in result_list %}
            <span class="nt">&lt;li&gt;</span>
                <span class="nt">&lt;strong&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ result.link }}&quot;</span><span class="nt">&gt;</span>{{ result.title }}<span class="nt">&lt;/a&gt;&lt;/strong&gt;&lt;br</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;p&gt;</span>{{ result.summary }}<span class="nt">&lt;/p&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
            {% endfor %}
        <span class="nt">&lt;/ol&gt;</span>
    {% else %}
        <span class="nt">&lt;br/&gt;</span>
        <span class="nt">&lt;p&gt;</span>No results found<span class="nt">&lt;/p&gt;</span>
    {% endif %}
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-the-category-view">
<h3>14.2.3. Updating the Category View<a class="headerlink" href="#updating-the-category-view" title="Permalink to this headline">¶</a></h3>
<p>Update the category view to handle a HTTP <tt class="docutils literal"><span class="pre">POST</span></tt> request (i.e. when the user submits a search) and inject the results list into the context. The following code demonstrates this new functionality.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">category</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">category_name_url</span><span class="p">):</span>
    <span class="c"># Request our context</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c"># Change underscores in the category name to spaces.</span>
    <span class="c"># URL&#39;s don&#39;t handle spaces well, so we encode them as underscores.</span>
    <span class="n">category_name</span> <span class="o">=</span> <span class="n">decode_url</span><span class="p">(</span><span class="n">category_name_url</span><span class="p">)</span>

    <span class="c"># Build up the dictionary we will use as out template context dictionary.</span>
    <span class="n">context_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;category_name&#39;</span><span class="p">:</span> <span class="n">category_name</span><span class="p">,</span> <span class="s">&#39;category_name_url&#39;</span><span class="p">:</span> <span class="n">category_name_url</span><span class="p">}</span>

    <span class="n">cat_list</span> <span class="o">=</span> <span class="n">get_category_list</span><span class="p">()</span>
    <span class="n">context_dict</span><span class="p">[</span><span class="s">&#39;cat_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_list</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Find the category with the given name.</span>
        <span class="c"># Raises an exception if the category doesn&#39;t exist.</span>
        <span class="c"># We also do a case insensitive match.</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name__iexact</span><span class="o">=</span><span class="n">category_name</span><span class="p">)</span>
        <span class="n">context_dict</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category</span>
        <span class="c"># Retrieve all the associated pages.</span>
        <span class="c"># Note that filter returns &gt;= 1 model instance.</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-views&#39;</span><span class="p">)</span>

        <span class="c"># Adds our results list to the template context under name pages.</span>
        <span class="n">context_dict</span><span class="p">[</span><span class="s">&#39;pages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span>
    <span class="k">except</span> <span class="n">Category</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="c"># We get here if the category does not exist.</span>
        <span class="c"># Will trigger the template to display the &#39;no category&#39; message.</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;query&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">result_list</span> <span class="o">=</span> <span class="n">run_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">context_dict</span><span class="p">[</span><span class="s">&#39;result_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_list</span>

    <span class="c"># Go render the response and return it to the client.</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;rango/category.html&#39;</span><span class="p">,</span> <span class="n">context_dict</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="view-profile">
<h2>14.3. View Profile<a class="headerlink" href="#view-profile" title="Permalink to this headline">¶</a></h2>
<p>To add the view profile functionality, undertake the following steps.</p>
<div class="section" id="creating-the-profile-template">
<h3>14.3.1. Creating the Profile Template<a class="headerlink" href="#creating-the-profile-template" title="Permalink to this headline">¶</a></h3>
<p>First, create a new template called <tt class="docutils literal"><span class="pre">profile.html</span></tt>. In this template, add the following code.</p>
<div class="highlight-html"><div class="highlight"><pre>{% extends &quot;rango/base.html&quot; %}

{% block title %}Profile{% endblock %}

{% block body_block %}
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;hero-unit&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span> Profile <span class="nt">&lt;h1&gt;</span> <span class="nt">&lt;br/&gt;</span>
    <span class="nt">&lt;h2&gt;</span>{{ user.username }}<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;p&gt;</span>Email: {{ user.email }}<span class="nt">&lt;/p&gt;</span>

    {% if userprofile %}
        <span class="nt">&lt;p&gt;</span>Website: <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{ userprofile.website }}&quot;</span><span class="nt">&gt;</span>{{ userprofile.website }}<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;br/&gt;</span>
        {% if userprofile.picture %}
            <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ userprofile.picture.url }}&quot;</span>  <span class="nt">/&gt;</span>
        {% endif %}
    {% endif %}
<span class="nt">&lt;/div&gt;</span>
{% endblock %}
</pre></div>
</div>
</div>
<div class="section" id="creating-profile-view">
<h3>14.3.2. Creating Profile View<a class="headerlink" href="#creating-profile-view" title="Permalink to this headline">¶</a></h3>
<p>Create a view called <tt class="docutils literal"><span class="pre">profile</span></tt> and add the following code.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">cat_list</span> <span class="o">=</span> <span class="n">get_category_list</span><span class="p">()</span>
    <span class="n">context_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;cat_list&#39;</span><span class="p">:</span> <span class="n">cat_list</span><span class="p">}</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">up</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">up</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">context_dict</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
    <span class="n">context_dict</span><span class="p">[</span><span class="s">&#39;userprofile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">up</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;rango/profile.html&#39;</span><span class="p">,</span> <span class="n">context_dict</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="mapping-the-profile-view-and-url">
<h3>14.3.3. Mapping the Profile View and URL<a class="headerlink" href="#mapping-the-profile-view-and-url" title="Permalink to this headline">¶</a></h3>
<p>Create a mapping between the URL <tt class="docutils literal"><span class="pre">/rango/profile</span></tt> and the <tt class="docutils literal"><span class="pre">profile()</span></tt> view. Do this by updating the <tt class="docutils literal"><span class="pre">urlpatterns</span></tt> tuple in <tt class="docutils literal"><span class="pre">rango/urls.py</span></tt> so that it includes the following entry.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">url</span><span class="p">(</span><span class="s">r&#39;^profile/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">profile</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;profile&#39;</span><span class="p">),</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3>14.3.4. Updating the Base Template<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>In the <tt class="docutils literal"><span class="pre">base.html</span></tt> template, update the code to put a link to the profile page in the menu bar.</p>
<div class="highlight-html"><div class="highlight"><pre>{% if user.is_authenticated %}
    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/rango/profile&quot;</span><span class="nt">&gt;</span>Profile<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
{% endif %}
</pre></div>
</div>
</div>
</div>
<div class="section" id="track-page-click-throughs">
<h2>14.4. Track Page Click Throughs<a class="headerlink" href="#track-page-click-throughs" title="Permalink to this headline">¶</a></h2>
<p>Currently, Rango provides a direct link to external pages. This is not very good if you want to track the number of times each page is clicked and viewed. To count the number of times a page is viewed via Rango you will need to perform the following steps.</p>
<div class="section" id="creating-a-url-tracking-view">
<h3>14.4.1. Creating a URL Tracking View<a class="headerlink" href="#creating-a-url-tracking-view" title="Permalink to this headline">¶</a></h3>
<p>Create a new view called <tt class="docutils literal"><span class="pre">track_url()</span></tt> in <tt class="docutils literal"><span class="pre">/rango/views.py</span></tt> which takes a parameterised HTTP <tt class="docutils literal"><span class="pre">GET</span></tt> request (i.e. <tt class="docutils literal"><span class="pre">rango/goto/?page_id=1</span></tt>) and updates the number of views for the page. The view should then redirect to the actual URL.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">track_url</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">page_id</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;/rango/&#39;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;page_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>
            <span class="n">page_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s">&#39;page_id&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">page_id</span><span class="p">)</span>
                <span class="n">page</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">views</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">page</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">url</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
<p>Be sure that you import the <tt class="docutils literal"><span class="pre">redirect()</span></tt> function to <tt class="docutils literal"><span class="pre">views.py</span></tt> if it isn&#8217;t included already!</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span>
</pre></div>
</div>
</div>
<div class="section" id="mapping-url">
<h3>14.4.2. Mapping URL<a class="headerlink" href="#mapping-url" title="Permalink to this headline">¶</a></h3>
<p>In <tt class="docutils literal"><span class="pre">/rango/urls.py</span></tt> add the following code to the <tt class="docutils literal"><span class="pre">urlpatterns</span></tt> tuple.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">url</span><span class="p">(</span><span class="s">r&#39;^goto/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">track_url</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;track_url&#39;</span><span class="p">),</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-the-category-template">
<h3>14.4.3. Updating the Category Template<a class="headerlink" href="#updating-the-category-template" title="Permalink to this headline">¶</a></h3>
<p>Update the <tt class="docutils literal"><span class="pre">category.html</span></tt> template so that it uses <tt class="docutils literal"><span class="pre">rango/goto/?page_id=XXX</span></tt> instead of providing the direct URL for users to click.</p>
<div class="highlight-html"><div class="highlight"><pre>{% if pages %}
<span class="nt">&lt;ul&gt;</span>
    {% for page in pages %}
    <span class="nt">&lt;li&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/rango/goto/?page_id={{page.id}}&quot;</span><span class="nt">&gt;</span>{{page.title}}<span class="nt">&lt;/a&gt;</span>
        {% if page.views &gt; 1 %}
            - ({{ page.views }} views)
        {% elif page.views == 1 %}
            - ({{ page.views }} view)
        {% endif %}
    <span class="nt">&lt;/li&gt;</span>
    {% endfor %}
<span class="nt">&lt;/ul&gt;</span>
{% else %}
<span class="nt">&lt;strong&gt;</span>No pages currently in category.<span class="nt">&lt;/strong&gt;&lt;br/&gt;</span>
{% endif %}
</pre></div>
</div>
<p>Here you can see that in the template we have added some control statements to display <tt class="docutils literal"><span class="pre">view</span></tt>, <tt class="docutils literal"><span class="pre">views</span></tt> or nothing depending on the value of <tt class="docutils literal"><span class="pre">page.views</span></tt>.</p>
</div>
<div class="section" id="updating-category-view">
<h3>14.4.4. Updating Category View<a class="headerlink" href="#updating-category-view" title="Permalink to this headline">¶</a></h3>
<p>Since we are tracking the number of click throughs you can now update the <tt class="docutils literal"><span class="pre">category()</span></tt> view so that you order the pages by the number of views. To confirm this works, click on a link and refresh the category view - the link you clicked should jump up the rankings.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        
        <li class="right" >
          <a href="ajax.html" title="15. AJAX, Django and JQuery"
             >next</a>
          </li>
		
        <li class="right" >
          <a href="tango.html" title="13. Making Rango Tango! Exercises"
             >previous</a>
          </li>
		
        <li><a href="../index-2.html">How to Tango with Django</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Leif Azzopardi and David Maxwell.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b3.
    </div>
  </body>

<!-- Mirrored from www.tangowithdjango.com/book/chapters/tango_too.html by HTTrack Website Copier/3.x [XR&CO'2008], Thu, 21 Nov 2013 06:40:53 GMT -->
</html>